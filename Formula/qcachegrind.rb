class Qcachegrind < Formula
  desc "Visualize data generated by Cachegrind and Calltree"
  homepage "https://kcachegrind.github.io/"
  url "https://download.kde.org/stable/release-service/21.04.3/src/kcachegrind-21.04.3.tar.xz"
  sha256 "25d01173e31b8715bd1b22546ef9c39cf4f555d9860a106d34588bae55793926"
  license "GPL-2.0-or-later"

  # We don't match versions like 19.07.80 or 19.07.90 where the patch number
  # is 80+ (beta) or 90+ (RC), as these aren't stable releases.
  livecheck do
    url "https://download.kde.org/stable/release-service/"
    regex(%r{href=.*?v?(\d+\.\d+\.(?:(?![89]\d)\d+)(?:\.\d+)*)/?["' >]}i)
  end

  bottle do
    sha256 cellar: :any, arm64_big_sur: "4381eb9eaf849f892a8928994e8a27678c20b08e5760cb11bdf18bbb4d7be225"
    sha256 cellar: :any, big_sur:       "8faba3f1ae57d0b2d3e8df17dd1bd601994a8f8017268b65fd3712dd50a93ea1"
    sha256 cellar: :any, catalina:      "afa6e9f0e87dd91c28c6daa6037fd20e0e1790af6356d0d9a5f62edd6602413b"
    sha256 cellar: :any, mojave:        "e291c1aed1dcc76494c2520114d06ca45d33ff5e9a0f4e2726bffdae1a3df98a"
  end

  depends_on "graphviz"
  depends_on "qt@5"

  def install
    spec = (ENV.compiler == :clang) ? "macx-clang" : "macx-g++"
    spec << "-arm64" if Hardware::CPU.arm?
    cd "qcachegrind" do
      system "#{Formula["qt@5"].opt_bin}/qmake", "-spec", spec,
                                               "-config", "release"
      system "make"

      on_macos do
        prefix.install "qcachegrind.app"
        bin.install_symlink prefix/"qcachegrind.app/Contents/MacOS/qcachegrind"
      end

      on_linux do
        bin.install "qcachegrind/qcachegrind"
      end
    end
  end
end
